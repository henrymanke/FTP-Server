services:
  nginx:
    image: nginx:latest
    container_name: nginx-server
    ports:
      - "8800:80"   # HTTP auf Host-Port 8800
      - "8843:443"  # HTTPS auf Host-Port 8843
    volumes:
      - ./ftpdata/storage_user/static:/usr/share/nginx/html/static  # Statik
      - ./ftpdata/storage_user/media:/usr/share/nginx/html/media    # Medien
      - ./nginx.conf:/etc/nginx/nginx.conf                          # Nginx-Konfiguration
      - ./certs:/etc/letsencrypt                                    # Zertifikate mounten
      - ./certs-data:/var/lib/letsencrypt                           # Certbot-Daten
      - ./log:/var/log/letsencrypt                                  # Certbot-Logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s       # Intervall zwischen den Checks
      timeout: 10s        # Timeout für den Check
      retries: 3          # Wie oft wird versucht, den Container zu prüfen, bevor er als "unhealthy" markiert wird
      start_period: 30s   # Wartezeit nach dem Start, bevor der erste Check ausgeführt wird

  certbot:
    image: certbot/certbot
    container_name: certbot
    command: /bin/sh -c "trap exit TERM; certbot certonly --webroot --webroot-path=/usr/share/nginx/html --email manke.henry@gmail.com --agree-tos --no-eff-email --force-renewal -d da-storage.de -d www.da-storage.de && nginx -s reload; while :; do sleep 12h & wait $${!}; certbot renew; done"
    volumes:
      - ./certs:/etc/letsencrypt                                    # Zertifikate mounten
      - ./certs-data:/var/lib/letsencrypt                           # Certbot-Daten
      - ./ftpdata/webroot:/usr/share/nginx/html                     # Webroot für die Zertifikatvalidierung
      - ./log:/var/log/letsencrypt                                  # Certbot-Logs
    entrypoint: /bin/sh -c "trap exit TERM; while :; do sleep 12h & wait $${!}; certbot renew; done"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/etc/letsencrypt/live/da-storage.de/fullchain.pem"]
      interval: 24h       # Überprüfung einmal täglich
      timeout: 10s
      retries: 3

  vsftpd:
    image: fauria/vsftpd
    container_name: vsftpd-server
    ports:
      - "20:20"
      - "21:21"
      - "21100-21110:21100-21110"
    environment:
      - FTP_USER=${FTP_USER}
      - FTP_PASS=${FTP_PASS}
      - FILE_OPEN_MODE=0755
      - LOCAL_UMASK=022
    volumes:
      - ./ftpdata:/home/vsftpd
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "21"]   # Prüft, ob der FTP-Port 21 geöffnet ist
      interval: 30s
      timeout: 10s
      retries: 3